---
interface Props { slug: string }
const { slug } = Astro.props;
---
<div class="like-container">
  <button id="like-button" class="like-button" data-slug={slug}>
    <span class="like-icon">ğŸ‘</span>
    <span id="like-count">èª­ã¿è¾¼ã¿ä¸­...</span>
  </button>
</div>

<script>
  document.addEventListener('DOMContentLoaded', async () => {
    const likeButton = document.getElementById('like-button') as HTMLButtonElement | null;
    const likeCount = document.getElementById('like-count');
    if (!likeButton || !likeCount) return;
    const slug = likeButton.dataset.slug;
    if (!slug) return;
    // å…±é€šã® API å‘¼ã³å‡ºã—
    const callLikeApi = async (method: 'GET' | 'POST') => {
      try {
        const res = await fetch(`/api/likes?slug=${slug}`, {
          method,
          headers: method === 'POST' ? { 'Content-Type': 'application/json' } : undefined,
        });
        if (!res.ok) throw new Error(`APIã‚¨ãƒ©ãƒ¼: ${res.status}`);
        const data = await res.json();
        return Number(data?.likes) || 0;
      } catch (err) {
        console.error(method === 'GET' ? 'ã„ã„ã­æ•°ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ:' : 'ã„ã„ã­ã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ:', err);
        return method === 'GET' ? 0 : null;
      }
    };
    // åˆæœŸåŒ–
    const initial = await callLikeApi('GET');
    likeCount.textContent = String(initial ?? 0);
    // ã‚¯ãƒªãƒƒã‚¯å‡¦ç†
    likeButton.addEventListener('click', async () => {
      likeButton.disabled = true;
      const newCount = await callLikeApi('POST');
      if (newCount !== null) likeCount.textContent = String(newCount);
      likeButton.disabled = false;
    });
  });
</script>

<style>
  .like-container {
    display: flex;
    justify-content: center;
    margin: 1rem 0;
  }
  .like-button {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.5rem 1rem;
    border: 1px solid #ddd;
    border-radius: 2rem;
    background-color: white;
    cursor: pointer;
    transition: all 0.2s ease;
  }
  .like-button:hover { background-color: #f5f5f5; transform: translateY(-2px); }
  .like-button:active { transform: translateY(0); }
  .like-icon { font-size: 1.2rem; }
</style>
